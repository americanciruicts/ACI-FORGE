# ============================================================================
# PostgreSQL Configuration for Consolidated Server
# ============================================================================
# This configuration file optimizes PostgreSQL for hosting multiple databases
# Adjust values based on your server's resources
# ============================================================================

# -----------------------------------------------------------------------------
# CONNECTION SETTINGS
# -----------------------------------------------------------------------------

# Maximum number of connections
# Rule of thumb: (RAM in GB) * 20, but cap at 200-300 for shared servers
max_connections = 200

# Connection pooling recommended for production
# Use PgBouncer or similar for connection pooling

# -----------------------------------------------------------------------------
# MEMORY SETTINGS
# -----------------------------------------------------------------------------

# Shared buffers: 25% of RAM (for dedicated server)
# Example: 4GB RAM = 1GB, 16GB RAM = 4GB
shared_buffers = 1GB

# Effective cache size: 50-75% of RAM
# This tells PostgreSQL how much memory is available for caching
effective_cache_size = 3GB

# Maintenance work memory: Used for VACUUM, CREATE INDEX, etc.
maintenance_work_mem = 256MB

# Work memory: Per-operation memory for sorting, hashing
# Total potential usage = work_mem * max_connections
# Be conservative: 4-8MB per connection
work_mem = 8MB

# -----------------------------------------------------------------------------
# QUERY PLANNING
# -----------------------------------------------------------------------------

# Random page cost (lower for SSD)
random_page_cost = 1.1  # 4.0 for HDD, 1.1 for SSD

# Effective IO concurrency (higher for SSD)
effective_io_concurrency = 200  # 1-2 for HDD, 200 for SSD

# -----------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
# -----------------------------------------------------------------------------

# WAL level for replication
wal_level = replica

# WAL buffers
wal_buffers = 16MB

# Checkpoint settings
checkpoint_completion_target = 0.9
min_wal_size = 1GB
max_wal_size = 4GB

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------

# Where to log
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# What to log
log_min_duration_statement = 1000  # Log queries taking > 1 second
log_connections = on
log_disconnections = on
log_duration = off
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Log slow queries
log_statement = 'none'  # none, ddl, mod, all
log_min_messages = warning

# Log lock waits
log_lock_waits = on
deadlock_timeout = 1s

# -----------------------------------------------------------------------------
# AUTOVACUUM
# -----------------------------------------------------------------------------

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 10s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# -----------------------------------------------------------------------------
# STATISTICS
# -----------------------------------------------------------------------------

# Track activity
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Statistics targets
default_statistics_target = 100

# -----------------------------------------------------------------------------
# SECURITY
# -----------------------------------------------------------------------------

# SSL/TLS (uncomment for production)
# ssl = on
# ssl_cert_file = '/path/to/server.crt'
# ssl_key_file = '/path/to/server.key'
# ssl_ca_file = '/path/to/root.crt'

# Password encryption
password_encryption = scram-sha-256

# -----------------------------------------------------------------------------
# PERFORMANCE
# -----------------------------------------------------------------------------

# Parallel query settings
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 4

# JIT compilation (PostgreSQL 11+)
jit = on

# -----------------------------------------------------------------------------
# REPLICATION (if needed)
# -----------------------------------------------------------------------------

# max_wal_senders = 10
# wal_keep_size = 1GB
# hot_standby = on

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------

# Timezone
timezone = 'UTC'

# Locale
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# RESOURCE USAGE PER DATABASE
# -----------------------------------------------------------------------------

# These can be set per database using ALTER DATABASE
# Example:
# ALTER DATABASE aci_dashboard SET work_mem = '16MB';
# ALTER DATABASE kosh_inventory SET maintenance_work_mem = '512MB';

# -----------------------------------------------------------------------------
# NOTES
# -----------------------------------------------------------------------------

# 1. Adjust memory settings based on your server's RAM
# 2. For Docker, mount this file at /etc/postgresql/postgresql.conf
# 3. Restart PostgreSQL after changes
# 4. Monitor performance and adjust as needed
# 5. Use pg_tune for automatic recommendations:
#    https://pgtune.leopard.in.ua/

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
